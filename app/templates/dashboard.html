<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio シナリオ管理画面</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>Twilio オートコール管理システム</h1>
        <nav>
            <button class="tab-btn active" onclick="openTab('tab-scenarios')">シナリオ設定</button>
            <button class="tab-btn" onclick="openTab('tab-outbound')">発信リスト・開始</button>
            <button class="tab-btn" onclick="openTab('tab-logs')">通話ログ・集計</button>
            <button class="tab-btn" onclick="openTab('tab-blacklist')">ブラックリスト</button>
        </nav>
    </header>

    <main>
        <!-- Tab 1: Scenarios -->
        <section id="tab-scenarios" class="tab-content active">
            <div class="split-view">
                <!-- Left: List -->
                <div class="sidebar panel">
                    <h2>シナリオ一覧</h2>
                    <button class="create-btn" onclick="showCreateScenarioForm()">
                        <i class="fas fa-plus"></i> 新規作成
                    </button>
                    <ul id="scenario-list">
                        <!-- JS renders list here -->
                    </ul>
                </div>

                <!-- Right: Details -->
                <div class="content panel" id="scenario-detail-panel">
                    <div id="welcome-message" style="text-align: center; color: #999; margin-top: 50px;">
                        <p>左側のリストからシナリオを選択するか、<br>新規作成してください。</p>
                    </div>

                    <!-- Scenario Edit Form -->
                    <div id="scenario-editor" class="hidden">
                        <div class="header-actions">
                            <h2 id="editor-title">シナリオ編集</h2>
                            <div class="stop-controls">
                                <button type="button" class="warning small" onclick="stopScenario('soft')">ソフト停止</button>
                                <button type="button" class="danger small" onclick="stopScenario('hard')">ハード停止</button>
                            </div>
                            <div>
                                <button type="button" class="copy-btn small" onclick="copyCurrentScenario()">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                                <button type="button" class="danger small" onclick="deleteCurrentScenario()">
                                    <i class="fas fa-trash"></i> 削除
                                </button>
                            </div>
                        </div>

                        <form id="scenario-form">
                            <input type="hidden" id="scenario-id">
                            
                            <div class="form-row">
                                <div class="form-group flex-2">
                                    <label>シナリオ名</label>
                                    <input type="text" id="scenario-name" placeholder="例：キャンペーンA用" required>
                                </div>
                                <div class="form-group flex-1">
                                    <label>会話モード</label>
                                    <select id="scenario-mode">
                                        <option value="A">A: 質問順守 (推奨)</option>
                                        <option value="B">B: 自由対話</option>
                                        <option value="C">C: ハイブリッド</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>開始時間</label>
                                    <input type="time" id="scenario-start-time" value="10:00">
                                </div>
                                <div class="form-group">
                                    <label>終了時間</label>
                                    <input type="time" id="scenario-end-time" value="18:00">
                                </div>
                                <div class="form-group">
                                    <label>無言(警告)</label>
                                    <input type="number" id="scenario-timeout-short" value="15" style="width: 60px;"> 秒
                                </div>
                                <div class="form-group">
                                    <label>無言(切断)</label>
                                    <input type="number" id="scenario-timeout-long" value="60" style="width: 60px;"> 秒
                                </div>
                            </div>

                            <div class="form-group">
                                <label>挨拶メッセージ</label>
                                <textarea id="scenario-greeting" placeholder="最初の一言"></textarea>
                            </div>

                            <div class="form-group">
                                <label>免責事項・録音告知</label>
                                <textarea id="scenario-disclaimer"></textarea>
                            </div>

                            <div class="form-group">
                                <label>質問開始ガイダンス</label>
                                <textarea id="scenario-guidance"></textarea>
                            </div>

                            <!-- Questions Area -->
                            <div id="questions-area">
                                <h3>質問リスト</h3>
                                <div id="questions-container"></div>
                                <div class="add-question-box">
                                    <textarea id="new-question-text" placeholder="質問文"></textarea>
                                    <button type="button" onclick="addQuestionToList()">追加</button>
                                </div>
                            </div>

                            <!-- Ending Guidance -->
                            <div id="ending-area">
                                <h3>終話ガイダンス</h3>
                                <div id="ending-container"></div>
                                <button type="button" onclick="addEndingGuidance()">追加</button>
                            </div>

                            <div class="form-row" style="margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                                <div class="form-group flex-1">
                                    <label>担当者番号 (ブリッジ先)</label>
                                    <input type="text" id="scenario-bridge" placeholder="+8190...">
                                </div>
                                <div class="form-group flex-1">
                                    <label>SMSテンプレート</label>
                                    <textarea id="scenario-sms" style="min-height: 50px;"></textarea>
                                </div>
                            </div>

                            <div class="actions-right">
                                <button type="submit" class="primary">保存する</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab 2: Outbound -->
        <section id="tab-outbound" class="tab-content">
            <div class="panel">
                <h2>発信リスト・実行</h2>
                <div class="actions-bar">
                    <select id="outbound-scenario-select">
                        <option value="">シナリオを選択</option>
                    </select>
                    <input type="file" id="target-csv" accept=".csv" style="display:none" onchange="handleFileUpload(this)">
                    <button class="secondary" onclick="document.getElementById('target-csv').click()">CSVアップロード</button>
                    <button class="primary" onclick="startCalls()">架電開始 (10件ずつ)</button>
                </div>
                <table id="targets-table">
                    <thead>
                        <tr>
                            <th>電話番号</th>
                            <th>ステータス</th>
                            <th>アップロード日時</th>
                            <th>備考</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Tab 3: Logs -->
        <section id="tab-logs" class="tab-content">
            <div class="panel">
                <h2>通話ログ</h2>
                <div class="filter-bar">
                    <input type="text" id="filter-phone" placeholder="電話番号で検索">
                    <button onclick="loadLogs()">更新</button>
                    <button onclick="exportZIP()">ZIP一括DL</button>
                </div>
                <table id="logs-table">
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>方向</th>
                            <th>電話番号</th>
                            <th>ステータス</th>
                            <th>分類</th>
                            <th>録音/文字起こし</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <!-- Tab 4: Blacklist -->
        <section id="tab-blacklist" class="tab-content">
            <div class="panel">
                <h2>ブラックリスト (オプトアウト)</h2>
                <div class="actions-bar">
                    <input type="text" id="blacklist-phone" placeholder="+81...">
                    <button onclick="addToBlacklist()">追加</button>
                </div>
                <table id="blacklist-table">
                    <thead>
                        <tr>
                            <th>電話番号</th>
                            <th>登録日</th>
                            <th>理由</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="/static/script.js?v={{ now_timestamp }}"></script>

</body>

</html>